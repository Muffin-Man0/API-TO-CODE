#!/usr/bin/env node
const { program } = require('commander');
const figlet = require('figlet');
const Printer = require('@darkobits/lolcatjs');
const shell = require('shelljs');
const {formatJSON,formatQueryObj} = require('../lib/json_format')
const chalk = require('chalk');
const inquirer = require('inquirer');
const ora = require('ora');
const { join } = require('path')
const download = require('download-git-repo');
const {
  copyTemplate,
  WriteAPI,
  generatorFunction,
  generatorInterface,
  generatorUrl,
  generatorAxiosFunction
} = require('../lib/utils/file')
const versionStr = figlet.textSync('API-TO-TSCode');


const spinner = ora(
  `ğŸ‰ æ­£åœ¨ç”Ÿæˆï¼Œè¯·ç¨ç­‰ \n`,
);


const generatorUniapp = async (path, output) => {

  try {

    const templatePath = join(__dirname, `../lib/template/uniapp`);
    const toPath = join(process.cwd(), output || `uniAPI`);

    // copy template
    copyTemplate(templatePath, toPath)

    // å†™å…¥è°ƒç”¨æ–¹æ³•
    WriteAPI(await generatorFunction(require(path)), join(toPath, 'httpApi.js'))

    // å†™å…¥baseURl
    WriteAPI(await generatorUrl(require(path)), join(toPath, `baseUrl.js`))


    spinner.text = `âœ”ï¸ ç”ŸæˆæˆåŠŸï¼Œç”Ÿæˆç›®å½•:${toPath}`
    spinner.succeed()
  } catch (error) {
    console.log(error);
    spinner.text = 'âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ä¼ å…¥æ­£ç¡®çš„swaggerAPIæ–‡ä»¶'
    spinner.fail()
  }
}


const generatorAxios = async (path, output) => {

  try {

    const templatePath = join(__dirname, `../lib/template/axios`);
    const toPath = join(process.cwd(),  output || `axios`);

    // copy template
    copyTemplate(templatePath, toPath)

    // å†™å…¥è°ƒç”¨æ–¹æ³•
    WriteAPI(await generatorAxiosFunction(require(path)), join(toPath, 'httpApi.ts'))

    // å†™å…¥baseURl
    WriteAPI(await generatorUrl(require(path)), join(toPath, `url.ts`))

    // ç”Ÿæˆinterface
    WriteAPI(await generatorInterface(formatQueryObj(formatJSON(require(path)))),join(toPath,'http.interface.ts'))

    spinner.text = `âœ”ï¸ ç”ŸæˆæˆåŠŸï¼Œç”Ÿæˆç›®å½•:${toPath}`
    spinner.succeed()
  } catch (error) {
    console.log(error);
    spinner.text = 'âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ä¼ å…¥æ­£ç¡®çš„swaggerAPIæ–‡ä»¶'
    spinner.fail()
  }
}



program
  .command('generator <type> <json>')
  .alias('g <type> <json>')
  .usage('-o <output>')
  .option('-o, --output <output>')
  .description('generator|g <SwaggerAPI> -O <output>')
  .action(async (type, cmd, { output }) => {
    const templatePath = join(process.cwd(), `${cmd}`);
    // const toPath = join(__dirname, `../apis`);
    console.log(cmd, type);
    spinner.start()

    if (cmd.endsWith('.json')) {
      switch (type) {
        case 'axios':
          generatorAxios(templatePath, output)
          break;
        case 'uniapp':
          generatorUniapp(templatePath, output)
          break;
        default:
          spinner.text = `ğŸ˜ ç›®å‰ä»…æ”¯æŒaxios,uniapp ${type}æ— æ•ˆ`
          spinner.warn()
          break;
      }

      return
    };

    spinner.text = 'âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ä¼ å…¥æ­£ç¡®jsonæ–‡ä»¶'
    spinner.fail()


  });
program.parse(process.argv);
